<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu Blog Atom Feed"><title data-react-helmet="true">Blog | Apache ShenYu</title><meta data-react-helmet="true" property="og:title" content="Blog | Apache ShenYu"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/page/2"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/page/2"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/page/2" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.f62ce902.css">
<link rel="preload" href="/zh/assets/js/runtime~main.0b72be01.js" as="script">
<link rel="preload" href="/zh/assets/js/main.d26a577b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo-light.svg" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh/download">下载</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">文档</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/index">next</a></li><li><a class="dropdown__link" href="/zh/docs/index">2.4.3</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.2/index">2.4.2</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.1/index">2.4.1</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.0/index">2.4.0</a></li><li><a class="dropdown__link" href="/zh/docs/2.3.0-Legacy/index">2.3.0-Legacy</a></li><li><a class="dropdown__link" href="/zh/versions">All Versions</a></li></ul></div><a class="navbar__item navbar__link" href="/zh/community/contributor-guide">社区</a><a class="navbar__item navbar__link" href="/zh/team">团队</a><a class="navbar__item navbar__link" href="/zh/event">事件</a><a class="navbar__item navbar__link" href="/zh/news">新闻</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a><a class="navbar__item navbar__link" href="/zh/users">用户</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><a href="https://github.com/apache/shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync">Etcd数据同步源码分析</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-08-01T09:05:18.162Z">2022年8月1日</time> · One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> 是一个异步的，高性能的，跨语言的，响应式的 <code>API</code> 网关。</p></blockquote><p>在<code>ShenYu</code>网关中，数据同步是指，当在后台管理系统中，数据发送了更新后，如何将更新的数据同步到网关中。<code>Apache ShenYu</code> 网关当前支持<code>ZooKeeper</code>、<code>WebSocket</code>、<code>Http长轮询</code>、<code>Nacos</code> 、<code>Etcd</code> 和 <code>Consul</code> 进行数据同步。本文的主要内容是基于<code>Etcd</code>的数据同步源码分析。</p><blockquote><p>本文基于<code>shenyu-2.4.0</code>版本进行源码分析，官网的介绍请参考 <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">数据同步原理</a> 。</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-关于etcd"></a>1. 关于Etcd<a class="hash-link" href="#1-关于etcd" title="Direct link to heading">#</a></h3><p><a href="https://github.com/etcd-io/etcd" target="_blank" rel="noopener noreferrer"><code>Etcd</code></a>是一个分布式的键值对存储系统，它为大型分布式计算提供分布式配置服务、同步服务和命名注册。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin数据同步"></a>2. Admin数据同步<a class="hash-link" href="#2-admin数据同步" title="Direct link to heading">#</a></h3><p>我们从一个实际案例进行源码追踪，比如在后台管理系统中，对<code>Divide</code>插件中的一条选择器数据进行更新，将权重更新为90：</p><p><img src="/zh/assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-接收数据"></a>2.1 接收数据<a class="hash-link" href="#21-接收数据" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>进入<code>SelectorController</code>类中的<code>updateSelector()</code>方法，它负责数据的校验，添加或更新数据，返回结果信息。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置当前选择器数据id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建或更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 返回结果信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-处理数据"></a>2.2 处理数据<a class="hash-link" href="#22-处理数据" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>在<code>SelectorServiceImpl</code>类中通过<code>createOrUpdate()</code>方法完成数据的转换，保存到数据库，发布事件，更新<code>upstream</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 负责事件发布的eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建数据 DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断是添加还是更新</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入选择器中的条件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 权限检查</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 更新数据，先删除再新增</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布事件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 更新upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在<code>Service</code>类完成数据的持久化操作，即保存数据到数据库，这个比较简单，就不深入追踪了。关于更新<code>upstream</code>操作，放到后面对应的章节中进行分析，重点关注发布事件的操作，它会执行数据同步。</p><p><code>publishEvent()</code>方法的逻辑是：找到选择器对应的插件，构建条件数据，发布变更数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 找到选择器对应的插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建条件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布变更数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>发布变更数据通过<code>eventPublisher.publishEvent()</code>完成，这个<code>eventPublisher</code>对象是一个<code>ApplicationEventPublisher</code>类，这个类的全限定名是<code>org.springframework.context.ApplicationEventPublisher</code>。看到这儿，我们知道了发布数据是通过<code>Spring</code>相关的功能来完成的。</p><blockquote><p>关于<code>ApplicationEventPublisher</code>：</p><p>当有状态发生变化时，发布者调用 <code>ApplicationEventPublisher</code> 的 <code>publishEvent</code> 方法发布一个事件，<code>Spring</code>容器广播事件给所有观察者，调用观察者的 <code>onApplicationEvent</code> 方法把事件对象传递给观察者。调用 <code>publishEvent</code>方法有两种途径，一种是实现接口由容器注入 <code>ApplicationEventPublisher</code> 对象然后调用其方法，另一种是直接调用容器的方法，两种方法发布事件没有太大区别。</p><ul><li><code>ApplicationEventPublisher</code>：发布事件；</li><li><code>ApplicationEvent</code>：<code>Spring</code> 事件，记录事件源、时间和数据；</li><li><code>ApplicationListener</code>：事件监听者，观察者；</li></ul></blockquote><p>在<code>Spring</code>的事件发布机制中，有三个对象，</p><p>一个是发布事件的<code>ApplicationEventPublisher</code>，在<code>ShenYu</code>中通过构造器注入了一个<code>eventPublisher</code>。</p><p>另一个对象是<code>ApplicationEvent</code>，在<code>ShenYu</code>中通过<code>DataChangedEvent</code>继承了它，表示事件对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>最后一个是 <code>ApplicationListener</code>，在<code>ShenYu</code>中通过<code>DataChangedEventDispatcher</code>类实现了该接口，作为事件的监听者，负责处理事件对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-分发数据"></a>2.3 分发数据<a class="hash-link" href="#23-分发数据" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>当事件发布完成后，会自动进入到<code>DataChangedEventDispatcher</code>类中的<code>onApplicationEvent()</code>方法，进行事件处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 有数据变更时，调用此方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历数据变更监听器(一般使用一种数据同步的方式就好了)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 哪种数据发生变更</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // 认证信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // 插件信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // 规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // 元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // 其他类型，抛出异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当有数据变更时，调用<code>onApplicationEvent</code>方法，然后遍历所有数据变更监听器，判断是哪种数据类型，交给相应的数据监听器进行处理。</p><p><code>ShenYu</code>将所有数据进行了分组，一共是五种：认证信息、插件信息、规则信息、选择器信息和元数据。</p><p>这里的数据变更监听器（<code>DataChangedListener</code>），就是数据同步策略的抽象，它的具体实现有：</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>这几个实现类就是当前<code>ShenYu</code>支持的同步策略：</p><ul><li><code>WebsocketDataChangedListener</code>：基于<code>websocket</code>的数据同步；</li><li><code>ZookeeperDataChangedListener</code>：基于<code>zookeeper</code>的数据同步；</li><li><code>ConsulDataChangedListener</code>：基于<code>consul</code>的数据同步；</li><li><code>EtcdDataDataChangedListener</code>：基于<code>etcd</code>的数据同步；</li><li><code>HttpLongPollingDataChangedListener</code>：基于<code>http长轮询</code>的数据同步；</li><li><code>NacosDataChangedListener</code>：基于<code>nacos</code>的数据同步；</li></ul><p>既然有这么多种实现策略，那么如何确定使用哪一种呢？</p><p>因为本文是基于<code>Etcd</code>的数据同步源码分析，所以这里以<code>EtcdDataDataChangedListener</code>为例，分析它是如何被加载并实现的。</p><p>通过查看对<code>EtcdDataDataChangedListener</code>类的调用，可以发现，它是在<code>DataSyncConfiguration</code>类进行配置的。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 数据同步配置类</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过springboot条件装配实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //省略了其他代码......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * The type Etcd listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @EnableConfigurationProperties(EtcdProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  static class EtcdListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdClient etcdClient(final EtcdProperties etcdProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Client client = Client.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .endpoints(etcdProperties.getUrl())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdClient(client);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 创建Etcd数据变更监听器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(EtcdDataDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataChangedListener etcdDataChangedListener(final EtcdClient etcdClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdDataDataChangedListener(etcdClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 创建Etcd数据初始化类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient        the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the etcd data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(EtcdDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdDataInit etcdDataInit(final EtcdClient etcdClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new EtcdDataInit(etcdClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //省略了其他代码......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这个配置类是通过<code>SpringBoot</code>条件装配类实现的。在<code>EtcdListener</code>类上面有几个注解：</p><ul><li><p><code>@Configuration</code>：配置文件，应用上下文；</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</code>：属性条件判断，满足条件，该配置类才会生效。也就是说，当我们有如下配置时，就会采用<code>etcd</code>进行数据同步。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     etcd:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties(EtcdProperties.class)</code>：导入另一个属性类<code>EtcdProperties</code>，<code>EtcdProperties</code>中各属性对应配置文件中以<code>shenyu.sync.etcd</code>作为前缀的各属性。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.etcd&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当我们在配置文件中配置了<code>shenyu.sync.etcd.url</code>属性时，<code>Admin</code>将采用<code>etcd</code>进行数据同步，此时配置类<code>EtcdListener</code>会生效，并生成<code>EtcdClient</code>, <code>EtcdDataDataChangedListener</code>和<code>EtcdDataInit</code>类型的bean。</p><ul><li>生成<code>EtcdClient</code>类型的bean，<code>etcdClient</code>，这个bean根据配置文件，配置了与etcd服务器的连接信息，可以直接操作etcd节点。</li><li>生成<code>EtcdDataDataChangedListener</code>类型的bean，<code>etcdDataDataChangedListener</code>，这个bean将bean<code>etcdClient</code>作为成员变量，当监听到事件时，进行回调操作，可以直接使用该bean操作etcd节点。</li><li>生成<code>EtcdDataInit</code>类型的bean，<code>etcdDataInit</code>，这个bean将bean<code>etcdClient</code>和bean<code>syncDataService</code>作为成员变量，使用<code>etcdClient</code>根据etcd路径，判断数据是否未初始化，当未初始化时，将调用syncDataService进行刷新操作，将在下文详述。
根据上文所述，在事件处理方法<code>onApplicationEvent()</code>中，就会到相应的<code>listener</code>中。在我们的案例中，是对一条选择器数据进行更新，数据同步采用的是<code>etcd</code>，所以，代码会进入到<code>EtcdDataDataChangedListener</code>进行选择器数据变更处理。</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    //DataChangedEventDispatcher.java</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历数据变更监听器(一般使用一种数据同步的方式就好了)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 哪种数据发生变更</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 省略了其他逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // 在我们的案例中，会进入到EtcdDataDataChangedListener进行选择器数据变更处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-etcd数据变更监听器"></a>2.4 Etcd数据变更监听器<a class="hash-link" href="#24-etcd数据变更监听器" title="Direct link to heading">#</a></h4><ul><li><p>EtcdDataDataChangedListener.onSelectorChanged()</p><p>在<code>onSelectorChanged()</code>方法中，判断操作类型，是刷新同步还是更新或创建同步。根据当前选择器数据信息判断节点是否在<code>etcd</code>中。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataDataChangedListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdDataDataChangedListener(final EtcdClient client) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 选择器信息发生改变</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 刷新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcdClient.deleteEtcdPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 发生变更的数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建选择器数据的真实路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          etcdClient.delete(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //create or update，创建或更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这部分是核心。<code>changed</code>表示需更新的<code>SelectorData</code>列表，<code>eventType</code>表示事件类型。当事件类型为刷新<code>REFRESH</code>，并且<code>SelectorData</code>有改动时，会先将etcd中该plugin下的selector节点都先删除。注意这里的条件<code>SelectorData</code>有改动是必须的，否则会出现没有改动时进行刷新，将所有selector节点都删除的bug。
获取到selector对应路径后，会对节点进行删除、创建或更新。</p><p>只要将变动的数据正确写入到<code>etcd</code>的节点上，<code>admin</code>这边的操作就执行完成了。</p><p>在我们当前的案例中，对<code>Divide</code>插件中的一条选择器数据进行更新，将权重更新为90，就会对图中的特定节点更新。</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>我们用时序图将上面的更新流程串联起来。</p><p><img src="/zh/assets/images/etcd-sync-sequence-admin-zh-d9ccd2c6bd5f9b3f135c5420b60fd403.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-网关数据同步"></a>3. 网关数据同步<a class="hash-link" href="#3-网关数据同步" title="Direct link to heading">#</a></h3><p>假设<code>ShenYu</code>网关已经在正常运行，使用的数据同步方式也是<code>etcd</code>。那么当在<code>admin</code>端更新选择器数据后，并且向<code>etcd</code>发送了变更的数据，那网关是如何接收并处理数据的呢？接下来我们就继续进行源码分析，一探究竟。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-etcdclient接收数据"></a>3.1 EtcdClient接收数据<a class="hash-link" href="#31-etcdclient接收数据" title="Direct link to heading">#</a></h4><ul><li>EtcdClient.watchDataChange()</li></ul><p>在网关端有一个<code>EtcdSyncDataService</code>类，它通过<code>etcdClient</code>订阅了数据节点，当数据发生变更时，可以感知到。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //省略其它代码</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      etcdClient.watchDataChange(path, (updateNode, updateValue) -&gt; cacheSelectorData(updateValue),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              this::unCacheSelectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //省略其它代码</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>Etcd</code>的<code>Watch</code>机制，会给订阅的客户端发送节点变更通知。在我们的案例中，更新选择器信息，就会进入到<code>watchDataChange()</code>方法。通过<code>cacheSelectorData()</code>去处理数据。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-处理数据"></a>3.2 处理数据<a class="hash-link" href="#32-处理数据" title="Direct link to heading">#</a></h4><ul><li>EtcdSyncDataService.cacheSelectorData()</li></ul><p>经过判空逻辑之后，缓存选择器数据的操作又交给了<code>PluginDataSubscriber</code>处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final SelectorData selectorData = GsonUtils.getInstance().fromJson(dataString, SelectorData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code>是一个接口，它只有一个<code>CommonPluginDataSubscriber</code>实现类，负责处理插件、选择器和规则数据。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-通用插件数据订阅者"></a>3.3 通用插件数据订阅者<a class="hash-link" href="#33-通用插件数据订阅者" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>它没有其他逻辑，直接调用<code>subscribeDataHandler()</code>方法。在方法中，更具数据类型（插件、选择器或规则），操作类型（更新或删除），去执行不同逻辑。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通用插件数据订阅者，负责处理所有插件、选择器和规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 处理选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅数据处理器，处理数据的更新或删除</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // 选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // 规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-数据缓存到内存"></a>3.4 数据缓存到内存<a class="hash-link" href="#34-数据缓存到内存" title="Direct link to heading">#</a></h4><p>那么更新一条选择器数据，会进入下面的逻辑：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 如果每个插件还有自己的处理逻辑，那么就去处理                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>一是将数据保存到网关的内存中。<code>BaseDataCache</code>是最终缓存数据的类，通过单例模式实现。选择器数据就存到了<code>SELECTOR_MAP</code>这个<code>Map</code>中。在后续使用的时候，也是从这里拿数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有变量</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有构造器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  公开方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  缓存选择器数据的Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 缓存选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // 更新操作，先删除再插入</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // 新增操作，直接放到Map中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>二是如果每个插件还有自己的处理逻辑，那么就去处理。  通过<code>idea</code>编辑器可以看到，当新增一条选择器后，有如下的插件还有处理。这里我们就不再展开了。</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>经过以上的源码追踪，并通过一个实际的案例，在<code>admin</code>端新增更新一条选择器数据，就将<code>etcd</code>数据同步的流程分析清楚了。</p><p>我们还是通过时序图将网关端的数据同步流程串联一下：</p><p><img src="/zh/assets/images/etcd-sync-sequence-gateway-zh-708de62d8fafbb80c133b20247674db6.png"></p><p>数据同步的流程已经分析完了，为了不让同步流程被打断，在分析过程中就忽略了其他逻辑。我们还需要分析<code>Admin</code>同步数据初始化和网关同步操作初始化的流程。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin同步数据初始化"></a>4. Admin同步数据初始化<a class="hash-link" href="#4-admin同步数据初始化" title="Direct link to heading">#</a></h3><p>当<code>admin</code>启动后，会将当前的数据信息全量同步到<code>etcd</code>中，实现逻辑如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataInit.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdDataInit(final EtcdClient client, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void run(final String... args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!etcdClient.exists(pluginPath) &amp;&amp; !etcdClient.exists(authPath) &amp;&amp; !etcdClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.info(&quot;Init all data from database&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>判断<code>etcd</code>中是否存在数据，如果不存在，则进行同步。</p><p><code>EtcdDataInit</code>实现了<code>CommandLineRunner</code>接口。它是<code>springboot</code>提供的接口，会在所有 <code>Spring Beans</code>初始化之后执行<code>run()</code>方法，常用于项目中初始化的操作。</p><ul><li>SyncDataService.syncAll()</li></ul><p>从数据库查询数据，然后进行全量数据同步，所有的认证信息、插件信息、选择器信息、规则信息和元数据信息。主要是通过<code>eventPublisher</code>发布同步事件。这里就跟前面提到的同步逻辑就又联系起来了，<code>eventPublisher</code>通过<code>publishEvent()</code>发布完事件后，有<code>ApplicationListener</code>执行事件变更操作，在<code>ShenYu</code>中就是前面提到的<code>DataChangedEventDispatcher</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 事件发布</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 全量数据同步</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步认证信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步插件信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步元数据信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-网关同步操作初始化"></a>5. 网关同步操作初始化<a class="hash-link" href="#5-网关同步操作初始化" title="Direct link to heading">#</a></h3><p>网关这边的数据同步初始化操作主要是订阅<code>etcd</code>中的节点，当有数据变更时，收到变更数据。这依赖于<code>Etcd</code>的<code>Watch</code>机制。在<code>ShenYu</code>中，负责<code>etcd</code>数据同步的是<code>EtcdSyncDataService</code>，也在前面提到过。</p><p><code>EtcdSyncDataService</code>的功能逻辑是在实例化的过程中完成的：对<code>etcd</code>中的<code>shenyu</code>数据同步节点完成订阅。这里的订阅分两类，一类是已经存在的节点上面数据发生更新，这通过<code>etcdClient.watchDataChange()</code>方法实现；另一类是当前节点下有新增或删除节点，即子节点发生变化，这通过<code>etcdClient.watchChildChange()</code>方法实现。</p><p><code>EtcdSyncDataService</code>的代码有点多，这里我们以插件数据的读取和订阅进行追踪，其他类型的数据操作原理是一样的。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * etcd 数据同步服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 在实例化的时候，完成从etcd中读取数据的操作，并订阅节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdSyncDataService(/*省略构造参数*/) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅插件、选择器和规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅认证数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 插件节点路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 所有插件节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; pluginZKs = etcdClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 订阅当前所有插件、选择器和规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅子节点（新增或删除一个插件）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchChildChange(pluginParent, (updateNode, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!updateNode.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 需要订阅子节点的所有插件、选择器和规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherAll(updateNode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅插件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当前插件路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 缓存到网关内存中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cachePluginData(etcdClient.get(pluginPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅插件节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void cachePluginData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final PluginData pluginData = GsonUtils.getInstance().fromJson(dataString, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional.ofNullable(pluginData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .flatMap(data -&gt; Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -&gt; e.onSubscribe(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅数据变更：更新或删除，两个lambda表达式分别为更新和删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchDataChange(pluginPath, (updatePath, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataPath = buildRealPath(pluginPath, updatePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataStr = etcdClient.get(dataPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final PluginData data = GsonUtils.getInstance().fromJson(dataStr, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Optional.ofNullable(data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .ifPresent(d -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSubscribe(d)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, deleteNode -&gt; deletePlugin(pluginName));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>上面的源代码中都给出了注释，相信大家可以看明白。订阅插件数据的主要逻辑如下：</p><blockquote><ol><li>构造当前插件路径</li><li>读取etcd上当前节点数据，并反序列化</li><li>插件数据缓存到网关内存中</li><li>订阅插件节点</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-总结"></a>6. 总结<a class="hash-link" href="#6-总结" title="Direct link to heading">#</a></h3><p>本文通过一个实际案例，对<code>etcd</code>的数据同步原理进行了源码分析。涉及到的主要知识点如下：</p><ul><li>基于<code>etcd</code>的数据同步，主要是通过<code>watch</code>机制实现；</li><li>通过<code>Spring</code>完成事件发布和监听；</li><li>通过抽象<code>DataChangedListener</code>接口，支持多种同步策略，面向接口编程；</li><li>使用单例设计模式实现缓存数据类<code>BaseDataCache</code>；</li><li>通过<code>SpringBoot</code>的条件装配和<code>starter</code>加载机制实现配置类的加载。</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/etcd">etcd</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync">Nacos数据同步源码分析</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-08-01T09:05:18.162Z">2022年8月1日</time> · One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> 是一个异步的，高性能的，跨语言的，响应式的 <code>API</code> 网关。</p></blockquote><p>在<code>ShenYu</code>网关中，数据同步是指，当在后台管理系统中，数据发送了更新后，如何将更新的数据同步到网关中。<code>Apache ShenYu</code> 网关当前支持<code>ZooKeeper</code>、<code>WebSocket</code>、<code>Http长轮询</code>、<code>Nacos</code> 、<code>Etcd</code> 和 <code>Consul</code> 进行数据同步。本文的主要内容是基于<code>Nacos</code>的数据同步源码分析。</p><blockquote><p>本文基于<code>shenyu-2.4.0</code>版本进行源码分析，官网的介绍请参考 <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">数据同步原理</a> 。</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-关于nacos"></a>1. 关于Nacos<a class="hash-link" href="#1-关于nacos" title="Direct link to heading">#</a></h3><p><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer"><code>Nacos</code></a> 平台用于动态服务发现，以及配置和服务管理。 <code>Shenyu</code>网关可选择使用<code>Nacos</code>进行数据同步。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin数据同步"></a>2. Admin数据同步<a class="hash-link" href="#2-admin数据同步" title="Direct link to heading">#</a></h3><p>我们从一个实际案例进行源码追踪，比如在后台管理系统中，对<code>Divide</code>插件中的一条选择器数据进行更新，将权重更新为90：</p><p><img src="/zh/assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-接收数据"></a>2.1 接收数据<a class="hash-link" href="#21-接收数据" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>进入<code>SelectorController</code>类中的<code>updateSelector()</code>方法，它负责数据的校验，添加或更新数据，返回结果信息。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置当前选择器数据id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建或更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 返回结果信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-处理数据"></a>2.2 处理数据<a class="hash-link" href="#22-处理数据" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>在<code>SelectorServiceImpl</code>类中通过<code>createOrUpdate()</code>方法完成数据的转换，保存到数据库，发布事件，更新<code>upstream</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 负责事件发布的eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建数据 DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断是添加还是更新</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入选择器中的条件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 权限检查</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 更新数据，先删除再新增</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布事件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 更新upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在<code>Service</code>类完成数据的持久化操作，即保存数据到数据库，这个比较简单，就不深入追踪了。关于更新<code>upstream</code>操作，放到后面对应的章节中进行分析，重点关注发布事件的操作，它会执行数据同步。</p><p><code>publishEvent()</code>方法的逻辑是：找到选择器对应的插件，构建条件数据，发布变更数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 找到选择器对应的插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建条件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布变更数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>发布变更数据通过<code>eventPublisher.publishEvent()</code>完成，这个<code>eventPublisher</code>对象是一个<code>ApplicationEventPublisher</code>类，这个类的全限定名是<code>org.springframework.context.ApplicationEventPublisher</code>。看到这儿，我们知道了发布数据是通过<code>Spring</code>相关的功能来完成的。</p><blockquote><p>关于<code>ApplicationEventPublisher</code>：</p><p>当有状态发生变化时，发布者调用 <code>ApplicationEventPublisher</code> 的 <code>publishEvent</code> 方法发布一个事件，<code>Spring</code>容器广播事件给所有观察者，调用观察者的 <code>onApplicationEvent</code> 方法把事件对象传递给观察者。调用 <code>publishEvent</code>方法有两种途径，一种是实现接口由容器注入 <code>ApplicationEventPublisher</code> 对象然后调用其方法，另一种是直接调用容器的方法，两种方法发布事件没有太大区别。</p><ul><li><code>ApplicationEventPublisher</code>：发布事件；</li><li><code>ApplicationEvent</code>：<code>Spring</code> 事件，记录事件源、时间和数据；</li><li><code>ApplicationListener</code>：事件监听者，观察者；</li></ul></blockquote><p>在<code>Spring</code>的事件发布机制中，有三个对象，</p><p>一个是发布事件的<code>ApplicationEventPublisher</code>，在<code>ShenYu</code>中通过构造器注入了一个<code>eventPublisher</code>。</p><p>另一个对象是<code>ApplicationEvent</code>，在<code>ShenYu</code>中通过<code>DataChangedEvent</code>继承了它，表示事件对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>最后一个是 <code>ApplicationListener</code>，在<code>ShenYu</code>中通过<code>DataChangedEventDispatcher</code>类实现了该接口，作为事件的监听者，负责处理事件对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-分发数据"></a>2.3 分发数据<a class="hash-link" href="#23-分发数据" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>当事件发布完成后，会自动进入到<code>DataChangedEventDispatcher</code>类中的<code>onApplicationEvent()</code>方法，进行事件处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 有数据变更时，调用此方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历数据变更监听器(一般使用一种数据同步的方式就好了)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 哪种数据发生变更</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // 认证信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // 插件信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // 规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // 元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // 其他类型，抛出异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当有数据变更时，调用<code>onApplicationEvent</code>方法，然后遍历所有数据变更监听器，判断是哪种数据类型，交给相应的数据监听器进行处理。</p><p><code>ShenYu</code>将所有数据进行了分组，一共是五种：认证信息、插件信息、规则信息、选择器信息和元数据。</p><p>这里的数据变更监听器（<code>DataChangedListener</code>），就是数据同步策略的抽象，它的具体实现有：</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>这几个实现类就是当前<code>ShenYu</code>支持的同步策略：</p><ul><li><code>WebsocketDataChangedListener</code>：基于<code>websocket</code>的数据同步；</li><li><code>ZookeeperDataChangedListener</code>：基于<code>zookeeper</code>的数据同步；</li><li><code>ConsulDataChangedListener</code>：基于<code>consul</code>的数据同步；</li><li><code>EtcdDataDataChangedListener</code>：基于<code>etcd</code>的数据同步；</li><li><code>HttpLongPollingDataChangedListener</code>：基于<code>http长轮询</code>的数据同步；</li><li><code>NacosDataChangedListener</code>：基于<code>nacos</code>的数据同步；</li></ul><p>既然有这么多种实现策略，那么如何确定使用哪一种呢？</p><p>因为本文是基于<code>Nacos</code>的数据同步源码分析，所以这里以<code>NacosDataChangedListener</code>为例，分析它是如何被加载并实现的。</p><p>通过查看对<code>NacosDataChangedListener</code>类的调用，可以发现，它是在<code>DataSyncConfiguration</code>类进行配置的。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 数据同步配置类</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过springboot条件装配实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //省略了其他代码......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Nacos listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(NacosConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class NacosListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Data changed listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener nacosDataChangedListener(final ConfigService configService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataChangedListener(configService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Nacos data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the nacos data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public NacosDataInit nacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataInit(configService, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //省略了其他代码......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这个配置类是通过<code>SpringBoot</code>条件装配类实现的。在<code>NacosListener</code>类上面有几个注解：</p><ul><li><p><code>@Configuration</code>：配置文件，应用上下文；</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code>：属性条件判断，满足条件，该配置类才会生效。也就是说，当我们有如下配置时，就会采用<code>nacos</code>进行数据同步。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(NacosConfiguration.class)</code>：导入另一个配置类<code>NacosConfiguration</code>，<code>NacosConfiguration</code>提供了一个方法<code>ConfigService nacosConfigService(final NacosProperties nacosProp)</code>，将Nacos属性转换为<code>ConfigService</code>类型的bean，而Nacos属性是通过<code>@EnableConfigurationProperties(NacosProperties.class)</code> 导入的。我们先看ConfigService类型的bean定义。再分析属性配置类和对应的属性配置文件。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(NacosProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register configService in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosProp the nacos configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ConfigService {@linkplain ConfigService}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(ConfigService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosProperties nacosProp) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosProp.getAcm() != null &amp;&amp; nacosProp.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use aliyun ACM service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosProp.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use subaccount ACM administrative authority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosProp.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosProp.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosProp.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getUsername())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosProp.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getPassword())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosProp.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这个方法主要分成两步，第一步根据是否使用了aliyun的ACM服务，从NacosProperties中获取不同的nacos路径和鉴权信息，第二步根据获取到的这些属性，使用Nacos官方的工厂方法，使用反射的方式，创建configService。</p><p>接下来，让我们分析一下Nacos的属性配置和对应的配置文件。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private NacosACMProperties acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUrl() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param url url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUrl(final String url) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.url = url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param username username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(final String username) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getPassword() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param password password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPassword(final String password) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosACMProperties getAcm() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param acm acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAcm(final NacosACMProperties acm) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.acm = acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class NacosACMProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean isEnabled() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param enabled enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEnabled(final boolean enabled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.enabled = enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getEndpoint() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param endpoint endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEndpoint(final String endpoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.endpoint = endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getAccessKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param accessKey accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setAccessKey(final String accessKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.accessKey = accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getSecretKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param secretKey secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setSecretKey(final String secretKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.secretKey = secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当我们在配置文件中配置了<code>shenyu.sync.nacos.url</code>属性时，将采用<code>nacos</code>进行数据同步，此时配置类<code>NacosListener</code>会生效，并生成<code>NacosDataChangedListener</code>和<code>NacosDataInit</code>类型的bean。</p><ul><li>生成<code>NacosDataChangedListener</code>类型的bean，<code>nacosDataChangedListener</code>，这个bean将<code>ConfigService</code>类型的bean作为成员变量，<code>ConfigService</code>是nacos官方提供的api，当<code>nacosDataChangedListener</code>监听到事件时，进行回调操作，可以通过该api直接与nacos服务器交互，修改配置。</li><li>生成<code>NacosDataInit</code>类型的bean，<code>nacosDataInit</code>，这个bean将bean<code>configService</code>和bean<code>syncDataService</code>作为成员变量，调用<code>Nacos</code>的api <code>configService</code>判断配置是否未初始化，未初始化则调用<code>syncDataService</code>进行刷新操作，将在下文详述。
根据上文所述，在事件处理方法<code>onApplicationEvent()</code>中，会触发相应的<code>listener</code>的操作。在我们的案例中，是对一条选择器数据进行更新，数据同步采用的是<code>nacos</code>，所以，代码会进入到<code>NacosDataChangedListener</code>进行选择器数据变更处理。</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    //DataChangedEventDispatcher.java</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历数据变更监听器(一般使用一种数据同步的方式就好了)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 哪种数据发生变更</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 省略了其他逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // 在我们的案例中，会进入到NacosDataChangedListener进行选择器数据变更处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-nacos数据变更监听器"></a>2.4 Nacos数据变更监听器<a class="hash-link" href="#24-nacos数据变更监听器" title="Direct link to heading">#</a></h4><ul><li><p>NacosDataChangedListener.onSelectorChanged()</p><p>在<code>onSelectorChanged()</code>方法中，判断操作类型，是刷新同步还是更新或创建同步。根据当前选择器数据信息判断节点是否在<code>etcd</code>中。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Use nacos to push data changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 选择器信息发生改变</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateSelectorMap(getConfig(NacosPathConstants.SELECTOR_DATA_ID));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SELECTOR_MAP.keySet().removeAll(SELECTOR_MAP.keySet());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishConfig(NacosPathConstants.SELECTOR_DATA_ID, SELECTOR_MAP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这部分是核心。<code>changed</code>表示需更新的<code>SelectorData</code>列表，<code>eventType</code>表示事件类型。<code>SELECTOR_MAP</code>的类型是<code>ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt;</code>，该map的key为selector所属的plugin的名称，value为该plugin下的selector列表。<code>NacosPathConstants.SELECTOR_DATA_ID</code>的值为<code>shenyu.selector.json</code>。操作步骤如下，第一步，使用<code>getConfig</code>方法调用<code>Nacos</code>的api，从<code>Nacos</code>获取<code>group</code>为<code>shenyu.selector.json</code>的配置信息，<code>updateSelectorMap</code>方法使用这些配置信息更新<code>SELECTOR_MAP</code>，这样就同步到了<code>Nacos</code>上最新的selector信息。第二步，再根据事件类型来更新<code>SELECTOR_MAP</code>，最后使用<code>publishConfig</code>方法，调用<code>Nacos</code>的api，将<code>Nacos</code>上，<code>group</code>为<code>shenyu.selector.json</code>的配置进行全量替换。</p><p>只要将变动的数据正确写入到<code>Nacos</code>上，<code>admin</code>这边的操作就执行完成了。</p><p>在我们当前的案例中，对<code>Divide</code>插件中的一条选择器数据进行更新，将权重更新为90，就会对图中的特定节点更新。</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>我们用时序图将上面的更新流程串联起来。</p><p><img src="/zh/assets/images/nacos-sync-sequence-admin-zh-73003e7cb52938c5528bbfcc58adfc17.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-网关数据同步"></a>3. 网关数据同步<a class="hash-link" href="#3-网关数据同步" title="Direct link to heading">#</a></h3><p>假设<code>ShenYu</code>网关已经在正常运行，使用的数据同步方式也是<code>nacos</code>。那么当在<code>admin</code>端更新选择器数据后，并且向<code>nacos</code>发送了变更的数据，那网关是如何接收并处理数据的呢？接下来我们就继续进行源码分析，一探究竟。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-nacossyncdataservice接收数据"></a>3.1 <code>NacosSyncDataService</code>接收数据<a class="hash-link" href="#31-nacossyncdataservice接收数据" title="Direct link to heading">#</a></h4><p>网关是通过<code>NacosSyncDataService</code>对<code>nacos</code>进行监听并获取数据更新的，但是在这部分内容之前，我们先看一下<code>NacosSyncDataService</code>类型的bean是如何生成的。答案是在Spring配置类<code>NacosSyncDataConfiguration</code>中定义的。我们看到<code>NacosSyncDataConfiguration</code>类上的注解，<code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code>，这个注解我们在上文对<code>ShenYu</code>的Admin端中的<code>NacosListener</code>类进行分析时看到过，是一个属性条件判断，满足条件，该配置类才会生效。也就是说，当我们在<code>Shenyu</code>网关端有如下配置时，就表示<code>Shenyu</code>网关端采用<code>nacos</code>进行数据同步，<code>NacosSyncDataConfiguration</code>这个配置类生效。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(NacosSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(NacosSyncDataConfiguration.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService     the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers   the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers   the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos config service config service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosConfig the nacos config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosConfig nacosConfig) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosConfig.getAcm() != null &amp;&amp; nacosConfig.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosConfig.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosConfig.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosConfig.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosConfig.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosConfig.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getUsername() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosConfig.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getPassword() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosConfig.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http config http config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosConfig nacosConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>我们重点关注一下上面代码中<code>nacosSyncDataService</code>这个bean的生成：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>是直接调用<code>NacosSyncDataService</code>的构造方法new了一个该类型的对象。我们继续看构造方法：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public NacosSyncDataService(final ConfigService configService, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(configService, pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.PLUGIN_DATA_ID, this::updatePluginMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.SELECTOR_DATA_ID, this::updateSelectorMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.RULE_DATA_ID, this::updateRuleMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.META_DATA_ID, this::updateMetaDataMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.AUTH_DATA_ID, this::updateAuthMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void watcherData(final String dataId, final OnChange oc) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Listener listener = new Listener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void receiveConfigInfo(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                oc.change(configInfo);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Executor getExecutor() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        oc.change(getConfigAndSignListener(dataId, listener));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LISTENERS.computeIfAbsent(dataId, key -&gt; new ArrayList&lt;&gt;()).add(listener);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>可以看到，在构造方法中调用了<code>start</code>方法，并且通过<code>watcherData</code>方法创建了监听器，并且关联了回调函数oc，由于我们正在分析selector类型组件的变化，对应的回调函数是<code>updateSelectorMap</code>。这个回调函数用于处理数据。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-处理数据"></a>3.2 处理数据<a class="hash-link" href="#32-处理数据" title="Direct link to heading">#</a></h4><ul><li>NacosCacheHandler.updateSelectorMap()</li></ul><p>经过判空逻辑之后，缓存选择器数据的操作又交给了<code>PluginDataSubscriber</code>处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateSelectorMap(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; selectorDataList = GsonUtils.getInstance().toObjectMapList(configInfo, SelectorData.class).values().stream().flatMap(Collection::stream).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDataList.forEach(selectorData -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.unSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.onSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (JsonParseException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;sync selector data have error:&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code>是一个接口，它只有一个<code>CommonPluginDataSubscriber</code>实现类，负责处理插件、选择器和规则数据。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-通用插件数据订阅者"></a>3.3 通用插件数据订阅者<a class="hash-link" href="#33-通用插件数据订阅者" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>它没有其他逻辑，直接调用<code>subscribeDataHandler()</code>方法。在方法中，更具数据类型（插件、选择器或规则），操作类型（更新或删除），去执行不同逻辑。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通用插件数据订阅者，负责处理所有插件、选择器和规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 处理选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅数据处理器，处理数据的更新或删除</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // 选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // 规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-数据缓存到内存"></a>3.4 数据缓存到内存<a class="hash-link" href="#34-数据缓存到内存" title="Direct link to heading">#</a></h4><p>那么更新一条选择器数据，会进入下面的逻辑：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 如果每个插件还有自己的处理逻辑，那么就去处理                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>一是将数据保存到网关的内存中。<code>BaseDataCache</code>是最终缓存数据的类，通过单例模式实现。选择器数据就存到了<code>SELECTOR_MAP</code>这个<code>Map</code>中。在后续使用的时候，也是从这里拿数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有变量</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有构造器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  公开方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  缓存选择器数据的Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 缓存选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // 更新操作，先删除再插入</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // 新增操作，直接放到Map中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>二是如果每个插件还有自己的处理逻辑，那么就去处理。  通过<code>idea</code>编辑器可以看到，当新增一条选择器后，有如下的插件还有处理。这里我们就不再展开了。</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>经过以上的源码追踪，并通过一个实际的案例，在<code>admin</code>端新增更新一条选择器数据，就将<code>nacos</code>数据同步的流程分析清楚了。</p><p>我们还是通过时序图将网关端的数据同步流程串联一下：</p><p><img src="/zh/assets/images/nacos-sync-sequence-gateway-zh-bdc1404f8b15c4ebb82baaa4485660ac.png"></p><p>数据同步的流程已经分析完了，为了不让同步流程被打断，在分析过程中就忽略了其他逻辑。网关同步操作初始化的流程在<code>NacosSyncDataService</code>的<code>start</code>方法中，我们在上文分析<code>网关数据同步</code>时分析过了，下面分析<code>Admin</code>的同步数据初始化。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin同步数据初始化"></a>4. Admin同步数据初始化<a class="hash-link" href="#4-admin同步数据初始化" title="Direct link to heading">#</a></h3><p><code>admin</code>端，<code>NacosDataInit</code>类型的bean，在<code>NacosListener</code>中进行定义和生成，如果<code>admin</code>的配置中指定了使用<code>nacos</code>进行数据同步，当<code>admin</code>启动后，会将当前的数据信息全量同步到<code>nacos</code>中，实现逻辑如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(NacosDataInit.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ConfigService configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService the nacos config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configService = configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginDataId = NacosPathConstants.PLUGIN_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authDataId = NacosPathConstants.AUTH_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataId = NacosPathConstants.META_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dataIdNotExist(pluginDataId) &amp;&amp; dataIdNotExist(authDataId) &amp;&amp; dataIdNotExist(metaDataId)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean dataIdNotExist(final String pluginDataId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String group = NacosPathConstants.GROUP;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long timeout = NacosPathConstants.DEFAULT_TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return configService.getConfig(pluginDataId, group, timeout) == null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NacosException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;Get data from nacos error.&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>判断<code>nacos</code>中是否存在数据，如果不存在，则进行同步。</p><p><code>NacosDataInit</code>实现了<code>CommandLineRunner</code>接口。它是<code>springboot</code>提供的接口，会在所有 <code>Spring Beans</code>初始化之后执行<code>run()</code>方法，常用于项目中初始化的操作。</p><ul><li>SyncDataService.syncAll()</li></ul><p>从数据库查询数据，然后进行全量数据同步，所有的认证信息、插件信息、选择器信息、规则信息和元数据信息。主要是通过<code>eventPublisher</code>发布同步事件。这里就跟前面提到的同步逻辑就又联系起来了，<code>eventPublisher</code>通过<code>publishEvent()</code>发布完事件后，有<code>ApplicationListener</code>执行事件变更操作，在<code>ShenYu</code>中就是前面提到的<code>DataChangedEventDispatcher</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 事件发布</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 全量数据同步</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步认证信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步插件信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步元数据信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-总结"></a>5. 总结<a class="hash-link" href="#5-总结" title="Direct link to heading">#</a></h3><p>本文通过一个实际案例，对<code>nacos</code>的数据同步原理进行了源码分析。涉及到的主要知识点如下：</p><ul><li>基于<code>nacos</code>的数据同步，主要是通过<code>watch</code>机制实现；</li><li>通过<code>Spring</code>完成事件发布和监听；</li><li>通过抽象<code>DataChangedListener</code>接口，支持多种同步策略，面向接口编程；</li><li>使用单例设计模式实现缓存数据类<code>BaseDataCache</code>；</li><li>通过<code>SpringBoot</code>的条件装配和<code>starter</code>加载机制实现配置类的加载。</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/nacos">nacos</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync">WebSocket数据同步源码分析</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-08-01T09:05:18.162Z">2022年8月1日</time> · One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>在<code>ShenYu</code>网关中，数据同步是指，当在后台管理系统中，数据发送了更新后，如何将更新的数据同步到网关中。<code>Apache ShenYu</code> 网关当前支持<code>ZooKeeper</code>、<code>WebSocket</code>、<code>Http长轮询</code>、<code>Nacos</code> 、<code>etcd</code> 和 <code>Consul</code> 进行数据同步。本文的主要内容是基于<code>WebSocket</code>的数据同步源码分析。</p><blockquote><p>本文基于<code>shenyu-2.4.0</code>版本进行源码分析，官网的介绍请参考 <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">数据同步原理</a> 。</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-关于websocket通信"></a>1. 关于WebSocket通信<a class="hash-link" href="#1-关于websocket通信" title="Direct link to heading">#</a></h3><p><code>WebSocket</code>协议诞生于<code>2008</code>年，在<code>2011</code>年成为国际标准。它可以双向通信，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息。<code>WebSocket</code>协议建立在 <code>TCP</code> 协议之上，属于应用层，性能开销小，通信高效，协议标识符是<code>ws</code>。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin数据同步"></a>2. Admin数据同步<a class="hash-link" href="#2-admin数据同步" title="Direct link to heading">#</a></h3><p>我们从一个实际案例进行源码追踪，比如在后台管理系统中，新增一条选择器数据：</p><p><img src="/zh/assets/images/add-selector-93ff1008c1b0b4627dd3329abc92a7bd.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-接收数据"></a>2.1 接收数据<a class="hash-link" href="#21-接收数据" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>进入<code>SelectorController</code>类中的<code>createSelector()</code>方法，它负责数据的校验，添加或更新数据，返回结果信息。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult createSelector(@Valid @RequestBody final SelectorDTO selectorDTO) { // @Valid 数校验</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 添加或更新数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer createCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 返回结果信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.CREATE_SUCCESS, createCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-处理数据"></a>2.2 处理数据<a class="hash-link" href="#22-处理数据" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>在<code>SelectorServiceImpl</code>类中通过<code>createOrUpdate()</code>方法完成数据的转换，保存到数据库，发布事件，更新<code>upstream</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 负责事件发布的eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建数据 DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断是添加还是更新</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入选择器中的条件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 权限检查</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 更新数据，先删除再新增</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布事件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 更新upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在<code>Service</code>类完成数据的持久化操作，即保存数据到数据库，这个大家应该很熟悉了，就不展开。关于更新<code>upstream</code>操作，放到后面对应的章节中进行分析，重点关注发布事件的操作，它会进行数据同步。</p><p><code>publishEvent()</code>方法的逻辑是：找到选择器对应的插件，构建条件数据，发布变更数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 找到选择器对应的插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建条件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布变更数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>发布变更数据通过<code>eventPublisher.publishEvent()</code>完成，这个<code>eventPublisher</code>对象是一个<code>ApplicationEventPublisher</code>类，这个类的全限定名是<code>org.springframework.context.ApplicationEventPublisher</code>。看到这儿，我们知道了发布数据是通过<code>Spring</code>相关的功能来完成的。</p><blockquote><p>关于<code>ApplicationEventPublisher</code>：</p><p>当有状态发生变化时，发布者调用 <code>ApplicationEventPublisher</code> 的 <code>publishEvent</code> 方法发布一个事件，<code>Spring</code>容器广播事件给所有观察者，调用观察者的 <code>onApplicationEvent</code> 方法把事件对象传递给观察者。调用 <code>publishEvent</code>方法有两种途径，一种是实现接口由容器注入 <code>ApplicationEventPublisher</code> 对象然后调用其方法，另一种是直接调用容器的方法，两种方法发布事件没有太大区别。</p><ul><li><code>ApplicationEventPublisher</code>：发布事件；</li><li><code>ApplicationEvent</code>：<code>Spring</code> 事件，记录事件源、时间和数据；</li><li><code>ApplicationListener</code>：事件监听者，观察者。</li></ul></blockquote><p>在<code>Spring</code>的事件发布机制中，有三个对象，</p><p>一个是发布事件的<code>ApplicationEventPublisher</code>，在<code>ShenYu</code>中通过构造器注入了一个<code>eventPublisher</code>。</p><p>另一个对象是<code>ApplicationEvent</code>，在<code>ShenYu</code>中通过<code>DataChangedEvent</code>继承了它，表示事件对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>最后一个是 <code>ApplicationListener</code>，在<code>ShenYu</code>中通过<code>DataChangedEventDispatcher</code>类实现了该接口，作为事件的监听者，负责处理事件对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-分发数据"></a>2.3 分发数据<a class="hash-link" href="#23-分发数据" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>当事件发布完成后，会自动进入到<code>DataChangedEventDispatcher</code>类中的<code>onApplicationEvent()</code>方法，进行事件处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 有数据变更时，调用此方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历数据变更监听器(一般使用一种数据同步的方式就好了)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 哪种数据发生变更</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // 认证信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // 插件信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // 规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // 元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // 其他类型，抛出异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当有数据变更时，调用<code>onApplicationEvent</code>方法，然后遍历所有数据变更监听器，判断是哪种数据类型，交给相应的数据监听器进行处理。</p><p><code>ShenYu</code>将所有数据进行了分组，一共是五种：认证信息、插件信息、规则信息、选择器信息和元数据。</p><p>这里的数据变更监听器（<code>DataChangedListener</code>），就是数据同步策略的抽象，它的具体实现有：</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>这几个实现类就是当前<code>ShenYu</code>支持的同步策略：</p><ul><li><code>WebsocketDataChangedListener</code>：基于<code>websocket</code>的数据同步；</li><li><code>ZookeeperDataChangedListener</code>：基于<code>zookeeper</code>的数据同步；</li><li><code>ConsulDataChangedListener</code>：基于<code>consul</code>的数据同步；</li><li><code>EtcdDataDataChangedListener</code>：基于<code>etcd</code>的数据同步；</li><li><code>HttpLongPollingDataChangedListener</code>：基于<code>http长轮询</code>的数据同步；</li><li><code>NacosDataChangedListener</code>：基于<code>nacos</code>的数据同步；</li></ul><p>既然有这么多种实现策略，那么如何确定使用哪一种呢？</p><p>因为本文是基于<code>websocket</code>的数据同步源码分析，所以这里以<code>WebsocketDataChangedListener</code>为例，分析它是如何被加载并实现的。</p><p>通过在源码工程中进行全局搜索，可以看到，它的实现是在<code>DataSyncConfiguration</code>类完成的。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 数据同步配置类</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过springboot条件装配实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * websocket数据同步（默认策略）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The WebsocketListener(default strategy).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;shenyu.sync.websocket.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(WebsocketSyncProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class WebsocketListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 配置websocket数据变更监听器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(WebsocketDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener websocketDataChangedListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new WebsocketDataChangedListener();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Websocket collector.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Websocket处理类：建立连接，发送消息，关闭连接等操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the websocket collector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(WebsocketCollector.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public WebsocketCollector websocketCollector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new WebsocketCollector();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Server endpoint exporter </span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the server endpoint exporter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ServerEndpointExporter.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ServerEndpointExporter serverEndpointExporter() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ServerEndpointExporter();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这个配置类是通过<code>SpringBoot</code>条件装配类实现的。在<code>WebsocketListener</code>类上面有几个注解：</p><ul><li><p><code>@Configuration</code>：配置文件，应用上下文；</p></li><li><p><code>@ConditionalOnProperty(name = &quot;shenyu.sync.websocket.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</code>：属性条件判断，满足条件，该配置类才会生效。也就是说，当我们有如下配置时，就会采用<code>websocket</code>进行数据同步。不过，这里需要注意下<code>matchIfMissing = true</code>这个属性，它表示，如果你没有如下的配置，该配置类也会生效。基于<code>websocket</code>的数据同步时官方推荐的方式，也是默认采用的方式。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    websocket:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties</code>：启用配置属性；</p></li></ul><p>当我们主动配置，采用<code>websocket</code>进行数据同步时，<code>WebsocketDataChangedListener</code>就会生成。所以在事件处理方法<code>onApplicationEvent()</code>中，就会到相应的<code>listener</code>中。在我们的案例中，是新增加了一条选择器数据，数据通过采用的是<code>websocket</code>，所以，代码会进入到<code>WebsocketDataChangedListener</code>进行选择器数据变更处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历数据变更监听器(一般使用一种数据同步的方式就好了)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 哪种数据发生变更</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 省略了其他逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // WebsocketDataChangedListener进行选择器数据变更处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-websocket数据变更监听器"></a>2.4 Websocket数据变更监听器<a class="hash-link" href="#24-websocket数据变更监听器" title="Direct link to heading">#</a></h4><ul><li><p>WebsocketDataChangedListener.onSelectorChanged()</p><p>在<code>onSelectorChanged()</code>方法中，将数据进行了封装，转成<code>WebsocketData</code>，然后通过<code>WebsocketCollector.send()</code>发送数据。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    // 选择器数据有更新</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; selectorDataList, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构造 WebsocketData 数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData&lt;SelectorData&gt; websocketData =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                new WebsocketData&lt;&gt;(ConfigGroupEnum.SELECTOR.name(), eventType.name(), selectorDataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 通过websocket发送数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="25-websocket发送数据"></a>2.5 Websocket发送数据<a class="hash-link" href="#25-websocket发送数据" title="Direct link to heading">#</a></h4><ul><li>WebsocketCollector.send()</li></ul><p>在<code>send()</code>方法中，判断了一下同步的类型，根据不同的类型，进行处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ServerEndpoint(value = &quot;/websocket&quot;, configurator = WebsocketConfigurator.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketCollector {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Send.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param message the message</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type    the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void send(final String message, final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(message)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果是MYSELF（第一次的全量同步）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (DataEventTypeEnum.MYSELF == type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 从threadlocal中获取session</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Session session = (Session) ThreadLocalUtil.get(SESSION_KEY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (session != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 向该session发送全量数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sendMessageBySession(session, message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 后续的增量同步</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 向所有的session中同步变更数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SESSION_SET.forEach(session -&gt; sendMessageBySession(session, message));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void sendMessageBySession(final Session session, final String message) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 通过websocket的session把消息发送出去</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            session.getBasicRemote().sendText(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.error(&quot;websocket send result is exception: &quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>我们给的案例是一个新增操作 ，是一个增量同步，所以会走</p><p><code>SESSION_SET.forEach(session -&gt; sendMessageBySession(session, message));</code></p><p>这个逻辑。</p><p>再通过</p><p><code>session.getBasicRemote().sendText(message);</code></p><p>将数据发送了出去。</p><p>至此，当<code>admin</code>端发生数据变更时，就将变更的数据以增量形式通过<code>WebSocket</code>发给了网关。</p><p>分析到这里，不知道大家有没有疑问呢？比如<code>session</code>是怎么来的？网关如何和<code>admin</code>建立连接的？</p><p>不要着急，我们接下来就进行网关端的同步分析。</p><p>不过，在继续源码分析前，我们用一张图将上面的分析过程串联起来。</p><p><img src="/zh/assets/images/websocket-data-sync-admin-56f75ad149ca3cd1ec07fd24c6194c5b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-网关数据同步"></a>3. 网关数据同步<a class="hash-link" href="#3-网关数据同步" title="Direct link to heading">#</a></h3><p>假设<code>ShenYu</code>网关已经在正常运行了，使用的数据同步方式也是<code>websocket</code>。那么当在<code>admin</code>端新增一条选择器数据后，并且通过<code>WebSocket</code>发送到网关，那网关是如何接收并处理数据的呢？接下来我们就继续进行源码分析，一探究竟。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-websocketclient接收数据"></a>3.1 WebsocketClient接收数据<a class="hash-link" href="#31-websocketclient接收数据" title="Direct link to heading">#</a></h4><ul><li>ShenyuWebsocketClient.onMessage()</li></ul><p>在网关端有一个<code>ShenyuWebsocketClient</code>类，它继承了<code>WebSocketClient</code>，可以和<code>WebSocket</code>建立连接并通信。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当在<code>admin</code>端通过<code>websocket</code>发送数据后，<code>ShenyuWebsocketClient</code>就可以通过<code>onMessage()</code>接收到数据，然后就可以自己进行处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 接受到消息后执行</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理接收到的数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handleResult(result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void handleResult(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 数据反序列化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 哪种数据类型，插件、选择器、规则...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 哪种操作类型，更新、删除...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String eventType = websocketData.getEventType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(websocketData.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        websocketDataHandler.executor(groupEnum, json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>接收到数据后，首先进行了反序列化操作，读取数据类型和操作类型，紧接着，就交给<code>websocketDataHandler.executor()</code>进行处理。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-执行websocket事件处理器"></a>3.2 执行Websocket事件处理器<a class="hash-link" href="#32-执行websocket事件处理器" title="Direct link to heading">#</a></h4><ul><li>WebsocketDataHandler.executor()</li></ul><p>通过工厂模式创建了<code>Websocket</code>数据处理器，每种数据类型，都提供了一个处理器：</p><blockquote><p>插件 --&gt; 插件数据处理器;</p><p>选择器 --&gt; 选择器数据处理器；</p><p>规则 --&gt; 规则数据处理器；</p><p>认证信息 --&gt; 认证数据处理器；</p><p>元数据 --&gt; 元数据处理器。</p></blockquote><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过工厂模式创建 Websocket数据处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Websocket cache handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketDataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final EnumMap&lt;ConfigGroupEnum, DataHandler&gt; ENUM_MAP = new EnumMap&lt;&gt;(ConfigGroupEnum.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Websocket data handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 每种数据类型，提供一个处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketDataHandler(final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 插件 --&gt; 插件数据处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.PLUGIN, new PluginDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 选择器 --&gt; 选择器数据处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.SELECTOR, new SelectorDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 规则 --&gt; 规则数据处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.RULE, new RuleDataHandler(pluginDataSubscriber));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 认证信息 --&gt; 认证数据处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.APP_AUTH, new AuthDataHandler(authDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 元数据 --&gt; 元数据处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.put(ConfigGroupEnum.META_DATA, new MetaDataHandler(metaDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Executor.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type      the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param json      the json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param eventType the event type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void executor(final ConfigGroupEnum type, final String json, final String eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 根据数据类型，找到对应的数据处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENUM_MAP.get(type).handle(json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>不同的数据类型，有不同的数据处理方式，所以有不同的实现类。但是它们之间也有相同的处理逻辑，所以可以通过模板方法设计模式来实现。相同的逻辑放在抽象类中的<code>handle()</code>方法中，不同逻辑就交给各自的实现类。</p><p><img src="/zh/assets/images/data-handler-313ae788eadfdabf405cdc55c74dbb21.png"></p><p>我们的案例是新增了一条选择器数据，所以会交给<code>SelectorDataHandler</code>（ 选择器 --&gt; 选择器数据处理器）进行数据处理。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-判断事件类型"></a>3.3 判断事件类型<a class="hash-link" href="#33-判断事件类型" title="Direct link to heading">#</a></h4><ul><li>AbstractDataHandler.handle()</li></ul><p>实现数据变更的通用逻辑处理：根据不同的操作类型调用不同方法。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractDataHandler&lt;T&gt; implements DataHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Convert list.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 不同的逻辑由各自实现类去实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param json the json</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract List&lt;T&gt; convert(String json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do refresh.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 不同的逻辑由各自实现类去实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doRefresh(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do update.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 不同的逻辑由各自实现类去实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doUpdate(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do delete.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 不同的逻辑由各自实现类去实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataList the data list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract void doDelete(List&lt;T&gt; dataList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 通用逻辑，抽象类实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handle(final String json, final String eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;T&gt; dataList = convert(json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(dataList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            DataEventTypeEnum eventTypeEnum = DataEventTypeEnum.acquireByName(eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (eventTypeEnum) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doRefresh(dataList);  //刷新数据，全量同步</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case UPDATE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case CREATE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doUpdate(dataList); // 更新或创建数据，增量同步</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doDelete(dataList);  // 删除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>新增一条选择器数据，是新增操作，通过<code>switch-case</code>进入到<code>doUpdate()</code>方法中。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-进入具体的数据处理器"></a>3.4 进入具体的数据处理器<a class="hash-link" href="#34-进入具体的数据处理器" title="Direct link to heading">#</a></h4><ul><li>SelectorDataHandler.doUpdate()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 选择器数据处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Selector data handler.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorDataHandler extends AbstractDataHandler&lt;SelectorData&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PluginDataSubscriber pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doUpdate(final List&lt;SelectorData&gt; dataList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataList.forEach(pluginDataSubscriber::onSelectorSubscribe);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>遍历数据，进入<code>onSelectorSubscribe()</code>方法。</p><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>它没有其他逻辑，直接调用<code>subscribeDataHandler()</code>方法。在方法中，更具数据类型（插件、选择器或规则），操作类型（更新或删除），去执行不同逻辑。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通用插件数据订阅者，负责处理所有插件、选择器和规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 处理选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅数据处理器，处理数据的更新或删除</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // 选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // 规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>那么新增一条选择器数据，会进入下面的逻辑：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 如果每个插件还有自己的处理逻辑，那么就去处理                  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>一是将数据保存到网关的内存中。<code>BaseDataCache</code>是最终缓存数据的类，通过单例模式实现。选择器数据就存到了<code>SELECTOR_MAP</code>这个<code>Map</code>中。在后续使用的时候，也是从这里拿数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有变量</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有构造器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  公开方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  缓存选择器数据的Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 缓存选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // 更新操作，先删除再插入</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // 新增操作，直接放到Map中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>二是如果每个插件还有自己的处理逻辑，那么就去处理。  通过<code>idea</code>编辑器可以看到，当新增一条选择器后，有如下的插件还有处理。这里我们就不再展开了。</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>经过以上的源码追踪，并通过一个实际的案例，在<code>admin</code>端新增一条选择器数据，就将<code>websocket</code>数据同步的流程分析清除了。</p><p>我们还是用下面的一张图将网关端的数据同步流程串联一下：</p><p><img src="/zh/assets/images/websocket-data-sync-gateway-181e89c69dc9b9d2569e858eb82431bf.png"></p><p>数据同步的流程已经分析完了，但是还有一些问题没有分析到，就是网关是如何跟<code>admin</code>建立连接的？</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-网关和admin建立websocket连接"></a>4. 网关和admin建立websocket连接<a class="hash-link" href="#4-网关和admin建立websocket连接" title="Direct link to heading">#</a></h3><ul><li>websocket配置</li></ul><p>在网关的配置文件中有如下配置，并且引入了相关依赖，就会启动<code>websocket</code>相关服务。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cross</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">parameter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> multi</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">websocket</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用websocket进行数据同步</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token key atrule" style="color:#00a4db">urls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">9095/websocket   </span><span class="token comment" style="color:#999988;font-style:italic"># admin端的websocket地址</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在网关中引入<code>websocket</code>的依赖。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!--shenyu data sync start use websocket--&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spring-boot-starter-sync-data-websocket</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Websocket数据同步配置</li></ul><p>通过<code>springboot</code>的条件装配，创建相关的<code>bean</code>。在网关启动的时候，如果我们配置了<code>shenyu.sync.websocket.urls</code>，那么<code>Websocket</code>数据同步配置就会被加载。这里通过<code>spring boot starter</code>完成依赖的加载。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocket数据同步配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过springboot实现条件注入</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocket sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(WebsocketSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.websocket&quot;, name = &quot;urls&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Websocket sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Websocket数据同步服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param websocketConfig   the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers   the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers   the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建websocketSyncDataService</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService websocketSyncDataService(final ObjectProvider&lt;WebsocketConfig&gt; websocketConfig, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;you use websocket sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new WebsocketSyncDataService(websocketConfig.getIfAvailable(WebsocketConfig::new), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Config websocket config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.websocket&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketConfig websocketConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new WebsocketConfig();  // 创建WebsocketConfig</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在项目的<code>resources/META-INF</code>目录先新建<code>spring.factories</code>文件，在文件中指明配置类。</p><p><img src="/zh/assets/images/websocket-springboot-starter-2cfd149ba2fb69ab514241e061fc22c9.png"></p><ul><li>Websocket数据同步服务</li></ul><p>在<code>WebsocketSyncDataService</code>中做了如下几件事情：</p><ul><li>读取配置中的<code>urls</code>，这个表示<code>admin</code>端的同步地址，有多个的话，使用&quot;,&quot;分割；</li><li>创建调度线程池，一个<code>admin</code>分配一个，用于执行定时任务；</li><li>创建<code>ShenyuWebsocketClient</code>，一个<code>admin</code>分配一个，用于和<code>admin</code>建立<code>websocket</code>通信；</li><li>开始和<code>admin</code>端的<code>websocket</code> 建立连接；</li><li>执行定时任务，每隔10秒执行一次。主要作用是判断<code>websocket</code>连接是否已经断开，如果已经断开，则尝试重连。如果没有断开，就进行 <code>ping-pong</code> 检测。</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocket数据同步服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Websocket sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebsocketSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;WebSocketClient&gt; clients = new ArrayList&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ScheduledThreadPoolExecutor executor;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Websocket sync cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 创建Websocket数据同步服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param websocketConfig      the websocket config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebsocketSyncDataService(final WebsocketConfig websocketConfig,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // admin端的同步地址，有多个的话，使用&quot;,&quot;分割</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String[] urls = StringUtils.split(websocketConfig.getUrls(), &quot;,&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建调度线程池，一个admin分配一个</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        executor = new ScheduledThreadPoolExecutor(urls.length, ShenyuThreadFactory.create(&quot;websocket-connect&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String url : urls) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //创建WebsocketClient，一个admin分配一个</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.add(new ShenyuWebsocketClient(new URI(url), Objects.requireNonNull(pluginDataSubscriber), metaDataSubscribers, authDataSubscribers));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (URISyntaxException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.error(&quot;websocket url({}) is error&quot;, url, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (WebSocketClient client : clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 和websocket server建立连接</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean success = client.connectBlocking(3000, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (success) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.info(&quot;websocket connection is successful.....&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    log.error(&quot;websocket connection is error.....&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 执行定时任务，每隔10秒执行一次</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 主要作用是判断websocket连接是否已经断开，如果已经断开，则尝试重连。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 如果没有断开，就进行 ping-pong 检测</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                executor.scheduleAtFixedRate(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (client.isClosed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            boolean reconnectSuccess = client.reconnectBlocking();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (reconnectSuccess) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.info(&quot;websocket reconnect server[{}] is successful.....&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                log.error(&quot;websocket reconnection server[{}] is error.....&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            client.sendPing();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.debug(&quot;websocket send to [{}] ping message successful&quot;, client.getURI().toString());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.error(&quot;websocket connect is error :{}&quot;, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, 10, 10, TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            /* client.setProxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress(&quot;proxyaddress&quot;, 80)));*/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;websocket connection...exception....&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 关闭 websocket client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (WebSocketClient client : clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!client.isClosed()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                client.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 关闭线程池</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.nonNull(executor)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuWebsocketClient</li></ul><p>在<code>ShenYu</code>中创建的<code>WebSocket</code>客户端，用于和<code>admin</code>端通信。第一次成功建立连接后，同步全量数据，后续进行增量同步。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 在ShenYu中自定义的WebSocket客户端</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type shenyu websocket client.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuWebsocketClient extends WebSocketClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private volatile boolean alreadySync = Boolean.FALSE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final WebsocketDataHandler websocketDataHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new shenyu websocket client.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 创建ShenyuWebsocketClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param serverUri             the server uri  服务端uri</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber 插件数据订阅器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers   the meta data subscribers 元数据订阅器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers   the auth data subscribers 认证数据订阅器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuWebsocketClient(final URI serverUri, final PluginDataSubscriber pluginDataSubscriber,final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(serverUri);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.websocketDataHandler = new WebsocketDataHandler(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 成功建立连接后执行</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onOpen(final ServerHandshake serverHandshake) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 防止重新建立连接时，再次执行，所以用alreadySync进行判断</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!alreadySync) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 同步所有数据，MYSELF 类型</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            send(DataEventTypeEnum.MYSELF.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            alreadySync = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 接收到消息后执行</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理接收到的数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handleResult(result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 关闭后执行</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onClose(final int i, final String s, final boolean b) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 失败后执行</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onError(final Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;ALL&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void handleResult(final String result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 数据反序列化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 哪种数据类型，插件、选择器、规则...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 哪种操作类型，更新、删除...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String eventType = websocketData.getEventType();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(websocketData.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        websocketDataHandler.executor(groupEnum, json, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-总结"></a>5. 总结<a class="hash-link" href="#5-总结" title="Direct link to heading">#</a></h3><p>本文通过一个实际案例，对<code>websocket</code>的数据同步原理进行了源码分析。涉及到的主要知识点如下：</p><ul><li><code>websocket</code>支持双向通信，性能好，推荐使用；</li><li>通过<code>Spring</code>完成事件发布和监听；</li><li>通过抽象<code>DataChangedListener</code>接口，支持多种同步策略，面向接口编程；</li><li>使用工厂模式创建 <code>WebsocketDataHandler</code>，实现不同数据类型的处理；</li><li>使用模板方法设计模式实现<code>AbstractDataHandler</code>，处理通用的操作类型；</li><li>使用单例设计模式实现缓存数据类<code>BaseDataCache</code>；</li><li>通过<code>SpringBoot</code>的条件装配和<code>starter</code>加载机制实现配置类的加载。</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/websocket">websocket</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin">Context-Path插件源码分析</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-08-01T09:05:18.162Z">2022年8月1日</time> · One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p>开始前，可以参考 <a href="/zh/blog/page/start-demo">这篇文章</a> 运行shenyu网关</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="正文"></a>正文<a class="hash-link" href="#正文" title="Direct link to heading">#</a></h3><p>首先，看<code>ContextPathPlugin#doExecute</code>方法，这是这个插件的核心。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. 从JVM缓存中取得contextMappingHandle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ContextMappingHandle contextMappingHandle = ContextPathPluginDataHandler.CACHED_HANDLE.get().obtainHandle(CacheKeyUtils.INST.getKey(rule));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. 根据contextMappingHandle设置shenyu上下文</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    buildContextPath(shenyuContext, contextMappingHandle);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return chain.execute(exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol><li><p>从JVM缓存中取得<code>contextMappingHandle</code></p><p>这里的<code>contextMappingHandle</code>是<code>ContextMappingHandle</code>类的实例，里面有两个成员变量：<code>contextPath</code>和<code>addPrefix</code></p><p>这两个变量在之前Admin里面的Rules表单里有出现过，是在数据同步的时候更新的。</p></li><li><p>根据contextMappingHandle设置shenyu上下文</p><p>下面是<code>ContextPathPlugin#buildContextPath</code>方法的源代码</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void buildContextPath(final ShenyuContext context, final ContextMappingHandle handle) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String realURI = &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. 设置shenyu的context path，根据contextPath的长度将真实URI的前缀去掉</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isNoneBlank(handle.getContextPath())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setContextPath(handle.getContextPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setModule(handle.getContextPath());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        realURI = context.getPath().substring(handle.getContextPath().length());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 加上前缀</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isNoneBlank(handle.getAddPrefix())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isNotBlank(realURI)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            realURI = handle.getAddPrefix() + realURI;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            realURI = handle.getAddPrefix() + context.getPath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.setRealUrl(realURI);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>设置shenyu的context path，<strong>根据contextPath的长度将真实URI的前缀去掉</strong></p><p>你可能会有疑问，<strong>这里所谓的「根据contextPath的长度」会不会有问题呢？</strong></p><p>实际上这样的判断是没有问题的，因为请求在被Selector和Rules匹配到之后，才会被插件处理。所以在设置好Selector和Rules的前提下，是完全可以满足转换特定contextPath的需求的。</p></li></ul></li></ol><p>然后，<code>ContextPathPlugin</code>类还有一个比较重要的方法<code>skip</code>，下面展示了部分代码。我们可以发现：<strong>如果是对RPC服务的调用，就会直接跳过context_path插件。</strong></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public Boolean skip(final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Objects.equals(rpcType, RpcTypeEnum.DUBBO.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.GRPC.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.TARS.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.MOTAN.getName())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            || Objects.equals(rpcType, RpcTypeEnum.SOFA.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>最后，context_path插件还有另一个类<code>ContextPathPluginDataHandler</code>。这个类的作用是订阅插件的数据，当插件配置被修改、删除、增加时，就往JVM缓存里面修改、删除、新增数据。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/context-path">Context-Path</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/IntegrationTest-Analysis">集成测试剖析</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-08-01T09:05:18.162Z">2022年8月1日</time> · One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><p>这篇文章将会对Apache ShenYu的集成测试进行深入剖析。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="什么是集成测试"></a>什么是集成测试？<a class="hash-link" href="#什么是集成测试" title="Direct link to heading">#</a></h3><p>集成测试在一些项目里也叫E2E (End To End)测试，主要用于测试各个模块组装成一个系统后是否能符合预期。</p><p>Apache ShenYu将集成测试放在了持续集成中，利用GitHub Action，在每次向主分支提交Pull Request或是Merge时触发。这样可以大大降低项目的维护成本，提升Apache ShenYu的稳定性。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="自动化的集成测试如何实现"></a>自动化的集成测试如何实现？<a class="hash-link" href="#自动化的集成测试如何实现" title="Direct link to heading">#</a></h3><p>Apache ShenYu中，集成测试的主要步骤体现在GitHub Action工作流的脚本中，如下所示，该脚本位于 <a href="https://github.com/apache/incubator-shenyu/tree/master/.github/workflows" target="_blank" rel="noopener noreferrer">~/.github/workflows</a>目录下。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> it</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pull_request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> master</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matrix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alibaba</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dubbo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>下面我将从这个yaml文件出发，带你剖析整个自动化集成测试的流程。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="工作流的触发"></a>工作流的触发<a class="hash-link" href="#工作流的触发" title="Direct link to heading">#</a></h3><p>由于我们在 <code>on</code> 中指定了 <code>pull_request</code> 和 <code>push.branch: master</code>，那么当我们提交pull_request或是merge分支到master（push）的时候，就会触发这个工作流。</p><p>关于更多GitHub Action的用法，可以参考 <a href="https://docs.github.com/en/actions" target="_blank" rel="noopener noreferrer">GitHub Action</a> 的文档，这里不会做详细的介绍。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="初始化环境"></a>初始化环境<a class="hash-link" href="#初始化环境" title="Direct link to heading">#</a></h3><ul><li>拉取代码</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">submodules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>设置跳过标志</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Set Skip Env Var</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./.github/actions/skip</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ci</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当发生的是一些对功能无关的改动（如改动文档）时，会跳过集成测试，以节约资源。</p><ul><li>缓存maven依赖、安装Java</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cache Maven Repos</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">java@v1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="构建整个项目同时构建docker镜像"></a>构建整个项目，同时构建docker镜像<a class="hash-link" href="#构建整个项目同时构建docker镜像" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">./mvnw -B clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Prelease,docker -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Dmaven.test.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>上面这行命令中，-P后面跟着<code>release,docker</code>，表示会激活pom文件中相关的profile配置。</p><p>而release和docker这两个profile，目前只在 <code>shenyu-dist</code> 下的几个子模块中存在。下面将以 <a href="https://github.com/apache/incubator-shenyu/tree/master/shenyu-dist/shenyu-admin-dist" target="_blank" rel="noopener noreferrer">shenyu-dist-admin</a> 模块为例，介绍profile为release和docker的配置的具体内容。另外，集成测试只使用了这一步构建的 <code>shenyu-admin</code> 镜像。</p><ul><li><p>首先是release</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">release</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">finalName</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache-shenyu-incubating-${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">finalName</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.maven.plugins</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">maven-assembly-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">admin-bin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">phase</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">package</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">phase</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">single</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">descriptors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">descriptor</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.basedir}/src/main/assembly/binary.xml</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">descriptor</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">descriptors</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tarLongFileMode</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">posix</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tarLongFileMode</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当-P后面跟着release时，就会激活上面的 <code>maven-assembly-plugin</code> 插件。而executions中将插件的执行时机绑定在了maven生命周期package中，这也就意味着，当我们执行 <code>mvn install</code> 的时候就会触发。</p><p>configuration中指定了我们编写好的 <code>binary.xml</code>，<code>maven-assembly-plugin</code> 插件将会按照这个文件，将需要的文件复制进来，并打包。你可以点击链接查看该文件：<a href="https://github.com/apache/incubator-shenyu/blob/master/shenyu-dist/shenyu-admin-dist/src/main/assembly/binary.xml" target="_blank" rel="noopener noreferrer">shenyu-dist/shenyu-admin-dist/src/main/assembly/binary.xml</a></p><p>根据这个文件，插件会将其他模块下打包好的jar包、配置文件、启动脚本等“复制”过来，最终打成 <code>tar.gz</code> 格式的压缩包。</p></li><li><p>然后是docker</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">docker</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activeByDefault</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activation</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.spotify</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">dockerfile-maven-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${dockerfile-maven-plugin.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tag-latest</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">latest</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">tag-version</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">build</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goal</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">goals</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tag</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execution</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">executions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache/shenyu-admin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">buildArgs</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">APP_NAME</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">apache-shenyu-incubating-${project.version}-admin-bin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">APP_NAME</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">buildArgs</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">configuration</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plugins</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">build</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">profile</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>类比上面的release，这里是激活 <code>dockerfile-maven-plugin</code> 插件。当 <code>mvn install -Pdocker</code> 时，插件就会利用我们编写好的dockerfile构建docker镜像。</p></li></ul><p>需要注意的是，dockerfile-maven-plugin目前对aarch64架构的设备支持有限，在aarch64架构的机器上运行该插件时会出现如下错误。且在本人写这篇文章的时候已经很久没有维护，这意味着aarch64架构的设备使用这个插件的问题在短期内不会解决。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Failed to execute goal com.spotify:dockerfile-maven-plugin:1.4.6:build </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tag-latest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> on project shenyu-admin-dist: Could not build image: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: java.lang.UnsatisfiedLinkError: could not load FFI provider jnr.ffi.provider.jffi.Provider: ExceptionInInitializerError: Can&#x27;t overwrite cause with java.lang.UnsatisfiedLinkError: java.lang.UnsatisfiedLinkError: /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: dlopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">/private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib, </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: no suitable image found.  Did find:</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> universal wrapper</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ERROR</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         /private/var/folders/w2/j27f16yj7cvf_1cxbgqb89vh0000gn/T/jffi4972193792308935312.dylib: no matching architecture </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> universal wrapper</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这里有个临时的解决方案：</p><ol><li><p>打开一个新的shell，输入如下命令，利用 socat 将 unix socket 路由到 tcp 端口</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">socat TCP-LISTEN:2375,range</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1/32,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>设置环境变量</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">DOCKER_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tcp://127.0.0.1:2375</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="构建examples模块"></a>构建examples模块<a class="hash-link" href="#构建examples模块" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build examples</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pexample </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.javadoc.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dmaven.test.skip=true </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples/pom.xml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>因为考虑到release的需要，目前项目根目录下的pom文件中不饱含example子模块，所以上面这个步骤另外构建了examples模块。</p><p>与上面类似，这行命令也会利用maven的插件构建镜像，以供我们后续docker编排使用。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="构建定制化网关"></a>构建定制化网关<a class="hash-link" href="#构建定制化网关" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build integrated tests</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">B clean install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pit </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">DskipTests </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/pom.xml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>为了细分Apache ShenYu的不同功能的集成测试，我们在这一步将构建集成测试模块定制的网关。所谓的“定制”就是在pom文件中引入需要的最少依赖，然后代替默认的 <code>shenyu-bootstrap</code>。与上面两个步骤类似，这一步也会构建出docker镜像。</p><p>值得注意的是，这里的打包构建的方式与 <code>shenyu-dist</code> 模块的有一些不同，你可以通过对比pom文件发现。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="运行docker-compose"></a>运行docker compose<a class="hash-link" href="#运行docker-compose" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Start docker compose</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">compose.yml up </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">d</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这一步将会根据集成测试模块下编写好的不同的 <code>docker-compose.yml</code> 文件，进行docker编排。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3.9&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-zk</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zk</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">6.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">alpine</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">redis</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-examples-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2048M</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu-integrated-test-http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">depends_on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">shenyu-admin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">condition</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service_healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">healthcheck</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CMD&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;wget&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://shenyu-integrated-test-http:9195/actuator/health&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">retries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>例如 <code>shenyu-integrated-test-http</code> 模块下的 <code>docker-compose.yml</code>，按顺序启动了zookeeper、redis、example、admin、网关等服务。其中，example、admin、网关的镜像是我们之前构建的。</p><p>其中，docker-compose利用 <code>depends_on</code> 确定了服务之间的拓扑关系，并且大部分服务都有相应的健康检查，待健康检查通过后才会启动下一个服务。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="运行健康检查等待docker-compose启动完毕"></a>运行健康检查，等待docker-compose启动完毕<a class="hash-link" href="#运行健康检查等待docker-compose启动完毕" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Wait for docker compose start up completely</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bash ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/script/healthcheck.sh</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在这一步，宿主机会运行 <code>healthcheck.sh</code> 这个脚本，然后利用 curl 命令访问各个服务列表（在services.list文件中）的健康状态接口 <code>/actuator/health</code>，一直到服务状态都为正常才会继续。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="运行测试"></a>运行测试<a class="hash-link" href="#运行测试" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./mvnw test </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Pit </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ./shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">integrated</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> matrix.case </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/pom.xml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">continue-on-error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这一步就是利用maven test命令，逐个执行 <code>/src/test/</code>  目录下的测试类。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="查看docker-compose日志"></a>查看Docker Compose日志<a class="hash-link" href="#查看docker-compose日志" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Check test result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">if</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> env.SKIP_CI </span><span class="token tag" style="color:#00009f">!=</span><span class="token plain"> &#x27;true&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    docker-compose -f ./shenyu-integrated-test/${{ matrix.case }}/docker-compose.yml logs --tail=&quot;all&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    if [[ ${{steps.test.outcome}} == &quot;failure&quot; ]]; then</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      echo &quot;Test Failed&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      exit 1</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    else</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      echo &quot;Test Successful&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      exit 0</span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    fi</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当工作流出现错误时，docker compose的日志可以帮助我们更好的排查问题，所以在这一步我们将docker compose的日志打印出来。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/integration-test">Integration Test</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeper数据同步源码分析</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-08-01T09:05:18.162Z">2022年8月1日</time> · One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> 是一个异步的，高性能的，跨语言的，响应式的 <code>API</code> 网关。</p></blockquote><p>在<code>ShenYu</code>网关中，数据同步是指，当在后台管理系统中，数据发送了更新后，如何将更新的数据同步到网关中。<code>Apache ShenYu</code> 网关当前支持<code>ZooKeeper</code>、<code>WebSocket</code>、<code>Http长轮询</code>、<code>Nacos</code> 、<code>Etcd</code> 和 <code>Consul</code> 进行数据同步。本文的主要内容是基于<code>ZooKeeper</code>的数据同步源码分析。</p><blockquote><p>本文基于<code>shenyu-2.4.0</code>版本进行源码分析，官网的介绍请参考 <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">数据同步原理</a> 。</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-关于zookeeper"></a>1. 关于ZooKeeper<a class="hash-link" href="#1-关于zookeeper" title="Direct link to heading">#</a></h3><p><a href="https://zh.wikipedia.org/wiki/Apache_ZooKeeper" target="_blank" rel="noopener noreferrer"><code>Apache ZooKeeper</code></a>是<code>Apache</code>软件基金会的一个软件项目，它为大型分布式计算提供开源的分布式配置服务、同步服务和命名注册。<code>ZooKeeper</code>节点将它们的数据存储于一个分层的名字空间，非常类似于一个文件系统或一个前缀树结构。客户端可以在节点读写，从而以这种方式拥有一个共享的配置服务。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin数据同步"></a>2. Admin数据同步<a class="hash-link" href="#2-admin数据同步" title="Direct link to heading">#</a></h3><p>我们从一个实际案例进行源码追踪，比如在后台管理系统中，对<code>Divide</code>插件中的一条选择器数据进行更新，将权重更新为90：</p><p><img src="/zh/assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-接收数据"></a>2.1 接收数据<a class="hash-link" href="#21-接收数据" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>进入<code>SelectorController</code>类中的<code>updateSelector()</code>方法，它负责数据的校验，添加或更新数据，返回结果信息。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置当前选择器数据id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建或更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 返回结果信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-处理数据"></a>2.2 处理数据<a class="hash-link" href="#22-处理数据" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>在<code>SelectorServiceImpl</code>类中通过<code>createOrUpdate()</code>方法完成数据的转换，保存到数据库，发布事件，更新<code>upstream</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 负责事件发布的eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建数据 DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断是添加还是更新</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入选择器中的条件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 权限检查</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 更新数据，先删除再新增</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布事件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 更新upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在<code>Serrvice</code>类完成数据的持久化操作，即保存数据到数据库，这个比较简单，就不深入追踪了。关于更新<code>upstream</code>操作，放到后面对应的章节中进行分析，重点关注发布事件的操作，它会执行数据同步。</p><p><code>publishEvent()</code>方法的逻辑是：找到选择器对应的插件，构建条件数据，发布变更数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 找到选择器对应的插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 构建条件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发布变更数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>发布变更数据通过<code>eventPublisher.publishEvent()</code>完成，这个<code>eventPublisher</code>对象是一个<code>ApplicationEventPublisher</code>类，这个类的全限定名是<code>org.springframework.context.ApplicationEventPublisher</code>。看到这儿，我们知道了发布数据是通过<code>Spring</code>相关的功能来完成的。</p><blockquote><p>关于<code>ApplicationEventPublisher</code>：</p><p>当有状态发生变化时，发布者调用 <code>ApplicationEventPublisher</code> 的 <code>publishEvent</code> 方法发布一个事件，<code>Spring</code>容器广播事件给所有观察者，调用观察者的 <code>onApplicationEvent</code> 方法把事件对象传递给观察者。调用 <code>publishEvent</code>方法有两种途径，一种是实现接口由容器注入 <code>ApplicationEventPublisher</code> 对象然后调用其方法，另一种是直接调用容器的方法，两种方法发布事件没有太大区别。</p><ul><li><code>ApplicationEventPublisher</code>：发布事件；</li><li><code>ApplicationEvent</code>：<code>Spring</code> 事件，记录事件源、时间和数据；</li><li><code>ApplicationListener</code>：事件监听者，观察者；</li></ul></blockquote><p>在<code>Spring</code>的事件发布机制中，有三个对象，</p><p>一个是发布事件的<code>ApplicationEventPublisher</code>，在<code>ShenYu</code>中通过构造器注入了一个<code>eventPublisher</code>。</p><p>另一个对象是<code>ApplicationEvent</code>，在<code>ShenYu</code>中通过<code>DataChangedEvent</code>继承了它，表示事件对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>最后一个是 <code>ApplicationListener</code>，在<code>ShenYu</code>中通过<code>DataChangedEventDispatcher</code>类实现了该接口，作为事件的监听者，负责处理事件对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-分发数据"></a>2.3 分发数据<a class="hash-link" href="#23-分发数据" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>当事件发布完成后，会自动进入到<code>DataChangedEventDispatcher</code>类中的<code>onApplicationEvent()</code>方法，进行事件处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 有数据变更时，调用此方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历数据变更监听器(一般使用一种数据同步的方式就好了)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 哪种数据发生变更</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // 认证信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // 插件信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // 规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // 元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // 其他类型，抛出异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当有数据变更时，调用<code>onApplicationEvent</code>方法，然后遍历所有数据变更监听器，判断是哪种数据类型，交给相应的数据监听器进行处理。</p><p><code>ShenYu</code>将所有数据进行了分组，一共是五种：认证信息、插件信息、规则信息、选择器信息和元数据。</p><p>这里的数据变更监听器（<code>DataChangedListener</code>），就是数据同步策略的抽象，它的具体实现有：</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>这几个实现类就是当前<code>ShenYu</code>支持的同步策略：</p><ul><li><code>WebsocketDataChangedListener</code>：基于<code>websocket</code>的数据同步；</li><li><code>ZookeeperDataChangedListener</code>：基于<code>zookeeper</code>的数据同步；</li><li><code>ConsulDataChangedListener</code>：基于<code>consul</code>的数据同步；</li><li><code>EtcdDataDataChangedListener</code>：基于<code>etcd</code>的数据同步；</li><li><code>HttpLongPollingDataChangedListener</code>：基于<code>http长轮询</code>的数据同步；</li><li><code>NacosDataChangedListener</code>：基于<code>nacos</code>的数据同步；</li></ul><p>既然有这么多种实现策略，那么如何确定使用哪一种呢？</p><p>因为本文是基于<code>Zookeeper</code>的数据同步源码分析，所以这里以<code>ZookeeperDataChangedListener</code>为例，分析它是如何被加载并实现的。</p><p>通过在源码工程中进行全局搜索，可以看到，它的实现是在<code>DataSyncConfiguration</code>类完成的。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 数据同步配置类</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过springboot条件装配实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * zookeeper数据同步</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Zookeeper listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.zookeeper&quot;, name = &quot;url&quot;)  // 条件属性，满足才会被加载</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(ZookeeperConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class ZookeeperListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 创建Zookeeper数据变更监听器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param zkClient the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ZookeeperDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener zookeeperDataChangedListener(final ZkClient zkClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ZookeeperDataChangedListener(zkClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Zookeeper data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *  创建 Zookeeper 数据初始化类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param zkClient        the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the zookeeper data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(ZookeeperDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public ZookeeperDataInit zookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new ZookeeperDataInit(zkClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //省略了其他代码......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这个配置类是通过<code>SpringBoot</code>条件装配类实现的。在<code>ZookeeperListener</code>类上面有几个注解：</p><ul><li><p><code>@Configuration</code>：配置文件，应用上下文；</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.zookeeper&quot;, name = &quot;url&quot;)</code>：属性条件判断，满足条件，该配置类才会生效。也就是说，当我们有如下配置时，就会采用<code>zookeeper</code>进行数据同步。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     zookeeper:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          sessionTimeout: 5000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          connectionTimeout: 2000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(ZookeeperConfiguration.class)</code>：导入另一个类<code>ZookeeperConfiguration</code>；</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  @EnableConfigurationProperties(ZookeeperProperties.class)  // 启用zk属性配置类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public class ZookeeperConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register zkClient in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 向 Spring IOC 容器注册 zkClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param zookeeperProp the zookeeper configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ZkClient {@linkplain ZkClient}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      @ConditionalOnMissingBean(ZkClient.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      public ZkClient zkClient(final ZookeeperProperties zookeeperProp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ZkClient(zookeeperProp.getUrl(), zookeeperProp.getSessionTimeout(), zookeeperProp.getConnectionTimeout()); // 读取zk配置信息，并创建zkClient</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.zookeeper&quot;) // zk属性配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>当我们主动配置，采用<code>zookeeper</code>进行数据同步时，<code>zookeeperDataChangedListener</code>就会生成。所以在事件处理方法<code>onApplicationEvent()</code>中，就会到相应的<code>listener</code>中。在我们的案例中，是对一条选择器数据进行更新，数据同步采用的是<code>zookeeper</code>，所以，代码会进入到<code>ZookeeperDataChangedListener</code>进行选择器数据变更处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历数据变更监听器(一般使用一种数据同步的方式就好了)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 哪种数据发生变更</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 省略了其他逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // 选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // 在我们的案例中，会进入到ZookeeperDataChangedListener进行选择器数据变更处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-zookeeper数据变更监听器"></a>2.4 Zookeeper数据变更监听器<a class="hash-link" href="#24-zookeeper数据变更监听器" title="Direct link to heading">#</a></h4><ul><li><p>ZookeeperDataChangedListener.onSelectorChanged()</p><p>在<code>onSelectorChanged()</code>方法中，判断操作类型，是刷新同步还是更新或创建同步。根据当前选择器数据信息判断节点是否在<code>zk</code>中。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 使用 zookeeper 发布变更数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 选择器信息发生改变</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 刷新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            deleteZkPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发生变更的数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 构建选择器数据的真实路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果是删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 删除当前数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                deleteZkPath(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 父节点路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(data.getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 创建父节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createZkNode(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插入或更新数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            insertZkNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建 zk 节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void createZkNode(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 不存在才创建</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(path)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkClient.createPersistent(path, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 插入zk节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void insertZkNode(final String path, final Object data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        createZkNode(path);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 通过 zkClient 写入数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.writeData(path, null == data ? &quot;&quot; : GsonUtils.getInstance().toJson(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>只要将变动的数据正确写入到<code>zk</code>的节点上，<code>admin</code>这边的操作就执行完成了。<code>ShenYu</code>在使用<code>zk</code>进行数据同步时，<code>zk</code>的节点是通过精心设计的。</p><p>在我们当前的案例中，对<code>Divide</code>插件中的一条选择器数据进行更新，将权重更新为90，就会对图中的特定节点更新。</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>我们用时序图将上面的更新流程串联起来。</p><p><img src="/zh/assets/images/zk-sync-sequence-admin-zh-afad1ef642b7130231c2ceacce236b34.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-网关数据同步"></a>3. 网关数据同步<a class="hash-link" href="#3-网关数据同步" title="Direct link to heading">#</a></h3><p>假设<code>ShenYu</code>网关已经在正常运行，使用的数据同步方式也是<code>zookeeper</code>。那么当在<code>admin</code>端更新选择器数据后，并且向<code>zk</code>发送了变更的数据，那网关是如何接收并处理数据的呢？接下来我们就继续进行源码分析，一探究竟。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-zkclient接收数据"></a>3.1 ZkClient接收数据<a class="hash-link" href="#31-zkclient接收数据" title="Direct link to heading">#</a></h4><ul><li>ZkClient.subscribeDataChanges()</li></ul><p>在网关端有一个<code>ZookeeperSyncDataService</code>类，它通过<code>ZkClient</code>订阅了数据节点，当数据发生变更时，可以感知到。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 使用 zookeeper 缓存数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // zkClient订阅数据节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeDataChanges(path, new IZkDataListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataChange(final String dataPath, final Object data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                cacheSelectorData(GsonUtils.getInstance().fromJson(data.toString(), SelectorData.class)); // 节点数据被更新</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataDeleted(final String dataPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                unCacheSelectorData(dataPath);  // 节点数据被删除</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 省略了其他逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ZooKeeper</code>的<code>Watch</code>机制，会给订阅的客户端发送节点变更通知。在我们的案例中，更新选择器信息，就会进入到<code>handleDataChange()</code>方法。通过<code>cacheSelectorData()</code>去处理数据。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-处理数据"></a>3.2 处理数据<a class="hash-link" href="#32-处理数据" title="Direct link to heading">#</a></h4><ul><li>ZookeeperSyncDataService.cacheSelectorData()</li></ul><p>经过判空逻辑之后，缓存选择器数据的操作又交给了<code>PluginDataSubscriber</code>处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code>是一个接口，它只有一个<code>CommonPluginDataSubscriber</code>实现类，负责处理插件、选择器和规则数据。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-通用插件数据订阅者"></a>3.3 通用插件数据订阅者<a class="hash-link" href="#33-通用插件数据订阅者" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>它没有其他逻辑，直接调用<code>subscribeDataHandler()</code>方法。在方法中，更具数据类型（插件、选择器或规则），操作类型（更新或删除），去执行不同逻辑。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通用插件数据订阅者，负责处理所有插件、选择器和规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 处理选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 订阅数据处理器，处理数据的更新或删除</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 插件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // 选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // 规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 从网关内存移除数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果每个插件还有自己的处理逻辑，那么就去处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-数据缓存到内存"></a>3.4 数据缓存到内存<a class="hash-link" href="#34-数据缓存到内存" title="Direct link to heading">#</a></h4><p>那么更新一条选择器数据，会进入下面的逻辑：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 将数据保存到网关内存</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 如果每个插件还有自己的处理逻辑，那么就去处理                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>一是将数据保存到网关的内存中。<code>BaseDataCache</code>是最终缓存数据的类，通过单例模式实现。选择器数据就存到了<code>SELECTOR_MAP</code>这个<code>Map</code>中。在后续使用的时候，也是从这里拿数据。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有变量</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有构造器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  公开方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  缓存选择器数据的Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 缓存选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // 更新操作，先删除再插入</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // 新增操作，直接放到Map中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>二是如果每个插件还有自己的处理逻辑，那么就去处理。  通过<code>idea</code>编辑器可以看到，当新增一条选择器后，有如下的插件还有处理。这里我们就不再展开了。</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>经过以上的源码追踪，并通过一个实际的案例，在<code>admin</code>端新增更新一条选择器数据，就将<code>zookeeper</code>数据同步的流程分析清楚了。</p><p>我们还是通过时序图将网关端的数据同步流程串联一下：</p><p><img src="/zh/assets/images/zk-sync-sequence-gateway-zh-0494aedc4de3f64c781fe8bb6c4b69bc.png"></p><p>数据同步的流程已经分析完了，为了不让同步流程被打断，在分析过程中就忽略了其他逻辑。我们还需要分析<code>Admin</code>同步数据初始化和网关同步操作初始化的流程。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin同步数据初始化"></a>4. Admin同步数据初始化<a class="hash-link" href="#4-admin同步数据初始化" title="Direct link to heading">#</a></h3><p>当<code>admin</code>启动后，会将当前的数据信息全量同步到<code>zk</code>中，实现逻辑如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Zookeeper 数据初始化</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ZkClient zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param zkClient        the zk client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ZookeeperDataInit(final ZkClient zkClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.zkClient = zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断zk中是否存在数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(pluginPath) &amp;&amp; !zkClient.exists(authPath) &amp;&amp; !zkClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>判断<code>zk</code>中是否存在数据，如果不存在，则进行同步。</p><p><code>ZookeeperDataInit</code>实现了<code>CommandLineRunner</code>接口。它是<code>springboot</code>提供的接口，会在所有 <code>Spring Beans</code>初始化之后执行<code>run()</code>方法，常用于项目中初始化的操作。</p><ul><li>SyncDataService.syncAll()</li></ul><p>从数据库查询数据，然后进行全量数据同步，所有的认证信息、插件信息、选择器信息、规则信息和元数据信息。主要是通过<code>eventPublisher</code>发布同步事件。这里就跟前面提到的同步逻辑就又联系起来了，<code>eventPublisher</code>通过<code>publishEvent()</code>发布完事件后，有<code>ApplicationListener</code>执行事件变更操作，在<code>ShenYu</code>中就是前面提到的<code>DataChangedEventDispatcher</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 事件发布</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 全量数据同步</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步认证信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步插件信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步选择器信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步规则信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同步元数据信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-网关同步操作初始化"></a>5. 网关同步操作初始化<a class="hash-link" href="#5-网关同步操作初始化" title="Direct link to heading">#</a></h3><p>网关这边的数据同步初始化操作主要是订阅<code>zk</code>中的节点，当有数据变更时，收到变更数据。这依赖于<code>ZooKeeper</code>的<code>Watch</code>机制。在<code>ShenYu</code>中，负责<code>zk</code>数据同步的是<code>ZookeeperSyncDataService</code>，也在前面提到过。</p><p><code>ZookeeperSyncDataService</code>的功能逻辑是在实例化的过程中完成的：对<code>zk</code>中的<code>shenyu</code>数据同步节点完成订阅。这里的订阅分两类，一类是已经存在的节点上面数据发生更新，这通过<code>zkClient.subscribeDataChanges()</code>方法实现；另一类是当前节点下有新增或删除节点，即子节点发生变化，这通过<code>zkClient.subscribeChildChanges()</code>方法实现。</p><p><code>ZookeeperSyncDataService</code>的代码有点多，这里我们以插件数据的读取和订阅进行追踪，其他类型的数据操作原理是一样的。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *  zookeeper 数据同步服务</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ZookeeperSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在实例化的时候，完成从zk中读取数据的操作，并订阅节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ZookeeperSyncDataService( /*省略构造参数参数*/ ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.zkClient = zkClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅插件、选择器和规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅认证数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅元数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 插件节点路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 所有插件节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; pluginZKs = zkClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 订阅当前所有插件、选择器和规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅子节点（新增或删除一个插件）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeChildChanges(pluginParent, (parentPath, currentChildren) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isNotEmpty(currentChildren)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (String pluginName : currentChildren) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 需要订阅子节点的所有插件、选择器和规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅插件数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅选择器数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅规则数据</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 当前插件路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 是否存在，不存在就创建</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!zkClient.exists(pluginPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkClient.createPersistent(pluginPath, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读取zk上当前节点数据，并反序列化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginData pluginData = null == zkClient.readData(pluginPath) ? null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                : GsonUtils.getInstance().fromJson((String) zkClient.readData(pluginPath), PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 缓存到网关内存中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅插件节点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   private void cachePluginData(final PluginData pluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // 省略实现逻辑，其实就是 CommonPluginDataSubscriber 中的操作，跟前面都能联系起来</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 订阅数据变更：更新或删除</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        zkClient.subscribeDataChanges(pluginPath, new IZkDataListener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataChange(final String dataPath, final Object data) {  // 更新操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                 // 省略实现逻辑，其实就是 CommonPluginDataSubscriber 中的操作，跟前面都能联系起来</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void handleDataDeleted(final String dataPath) {   // 删除操作</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  // 省略实现逻辑，其实就是 CommonPluginDataSubscriber 中的操作，跟前面都能联系起来</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>上面的源代码中都给出了注释，相信大家可以看明白。订阅插件数据的主要逻辑如下：</p><blockquote><ol><li>构造当前插件路径</li><li>路径是否存在，不存在就创建</li><li>读取zk上当前节点数据，并反序列化</li><li>插件数据缓存到网关内存中</li><li>订阅插件节点</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-总结"></a>6. 总结<a class="hash-link" href="#6-总结" title="Direct link to heading">#</a></h3><p>本文通过一个实际案例，对<code>zookeeper</code>的数据同步原理进行了源码分析。涉及到的主要知识点如下：</p><ul><li>基于<code>zookeeper</code>的数据同步，主要是通过<code>watch</code>机制实现；</li><li>通过<code>Spring</code>完成事件发布和监听；</li><li>通过抽象<code>DataChangedListener</code>接口，支持多种同步策略，面向接口编程；</li><li>使用单例设计模式实现缓存数据类<code>BaseDataCache</code>；</li><li>通过<code>SpringBoot</code>的条件装配和<code>starter</code>加载机制实现配置类的加载。</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/zookeeper">zookeeper</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog"><div class="pagination-nav__label">« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div></div>
<script src="/zh/assets/js/runtime~main.0b72be01.js"></script>
<script src="/zh/assets/js/main.d26a577b.js"></script>
</body>
</html>